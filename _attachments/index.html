<!DOCTYPE html>
<html>
    <head>
        <title>Mural Mapper</title>
        <link rel="stylesheet" href="style/main.css" type="text/css">
    </head>
    <body>
        <center>
        <h2>Public Art Locations</h2>
        <div id="muralmap"></div>
        <p>Send a geo-located tweet to <a href="http://twitter.com/PublicArtApp">@PublicArtApp</a> with location and a url to a photo of public artwork.</p>
        </center>
    </body>
    <script src="vendor/couchapp/loader.js"></script>
    <script src="http://maps.google.com/maps?file=api&amp;v=2&amp;sensor=true&amp;key=ABQIAAAARMJyzJrjhl3iSncF1sAuyxSqD3OvGGgmW9Q3zP03MHH3lJfv6BTQflugcEeTFvX5Zec-oMDR3XP7Iw" type="text/javascript"></script> 
    <script type="text/javascript" charset="utf-8">
        $.couch.app(function(app) {
		
            var iconBlue = new GIcon(); 
            iconBlue.image = 'http://labs.google.com/ridefinder/images/mm_20_blue.png';
            iconBlue.shadow = 'http://labs.google.com/ridefinder/images/mm_20_shadow.png';
            iconBlue.iconSize = new GSize(12, 20);
            iconBlue.shadowSize = new GSize(22, 20);
            iconBlue.iconAnchor = new GPoint(6, 20);
            iconBlue.infoWindowAnchor = new GPoint(5, 1);
	    
	        if (GBrowserIsCompatible()) {
                var map = new GMap2(document.getElementById("muralmap"));
                map.addControl(new GSmallMapControl());
                map.addControl(new GMapTypeControl());
                map.setCenter(new GLatLng(37.77493, -122.41942), 13);

                $.getJSON('_list/geojson/locations', function(data) {
                    var items = [];
                    //console.log(data);

                    $.each(data.features, function(key, val) {                     
                        var name = val.properties.name;
                        var text = val.properties.text;
                        var imagepath = val.properties.tweet_image;
                        var thumbnail = val.properties.thumbnail;
                        var point = new GLatLng(parseFloat(val.geometry.coordinates[1]), parseFloat(val.geometry.coordinates[0]));
                        var marker = createMarker(point, name, imagepath, text, thumbnail);
                        map.addOverlay(marker);
                    });
                });
	        }

            function createMarker(point, name, image, text, thumbnail) {
                var marker = new GMarker(point, iconBlue);
                var html = "<div><div style=\"float:left; width:60px; padding-right:5px; font-size:12px; font-style: italic;\"><a href=http://twitter.com/"+ name + " target=\"_blank\"><img id=\"thumb\" src=\"" + thumbnail + "\"/></a><span>@" + name + "</span></div><div style=\"float:left; width: 200px;\"><img width=\"200\" src=\""+image+ "\"/><div>";
                html += text.parseURL().parseUsername().parseHashtag();
                GEvent.addListener(marker, 'click', function() {
                  marker.openInfoWindowHtml(html);
                });
                return marker;
            }
	      
          
            String.prototype.parseURL = function() {
            	return this.replace(/[A-Za-z]+:\/\/[A-Za-z0-9-_]+\.[A-Za-z0-9-_:%&~\?\/.=]+/g, function(url) {
            		return url.link(url);
            	});
            };
          
            String.prototype.parseUsername = function() {
            	return this.replace(/[@]+[A-Za-z0-9-_]+/g, function(u) {
            		var username = u.replace("@","")
            		return u.link("http://twitter.com/"+username);
            	});
            };

            String.prototype.parseHashtag = function() {
            	return this.replace(/[#]+[A-Za-z0-9-_]+/g, function(t) {
            		var tag = t.replace("#","%23")
            		return t.link("http://search.twitter.com/search?q="+tag);
            	});
            };

	    });
    </script>
    <script src="/_utils/script/json2.js"></script>
    <script src="/_utils/script/jquery.js"></script>
    <script src="/_utils/script/jquery.couch.js"></script>
</html>
