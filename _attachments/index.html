<!DOCTYPE html>
<html>
    <head>
        <title>Mural Mapper</title>
        <link rel="stylesheet" href="style/main.css" type="text/css">
    </head>
    <body>
        <div id="content">
        <h2>Public Art Locations</h2>
        <p>Send a geo-located tweet to <a href="http://twitter.com/PublicArtApp">@PublicArtApp</a> with location and a url to a photo of public artwork.</p>
        <div id="muralmap"></div>
        <p>(Note: Currently only images posted via twicpic, yfrog, &amp; lockerz)</p>
        </div>
    </body>
    <script type="text/javascript">
        var artmapper_key = 'ABQIAAAARMJyzJrjhl3iSncF1sAuyxTHBAerHdRQ-KX7GOfc7ccH1_w28RQXOfqNMYuX1RYD7B5u9pBEkwVe7A';
        var iriscouch_key = 'ABQIAAAARMJyzJrjhl3iSncF1sAuyxSqD3OvGGgmW9Q3zP03MHH3lJfv6BTQflugcEeTFvX5Zec-oMDR3XP7Iw';
        var key_to_use = (location.hostname.indexOf('iriscouch') != -1) ? iriscouch_key : artmapper_key;
    </script>
    <script src="vendor/couchapp/loader.js"></script>
    <script type="text/javascript"
        src="http://maps.google.com/maps/api/js?sensor=false">
    </script>
    <script type="text/javascript" charset="utf-8">
        var map;
        $.couch.app(function(app) {
		    var map;
		    var allMarkers = [];
		    var markers = [];
            var iconBlue = new google.maps.MarkerImage(); 
            iconBlue.url = 'http://labs.google.com/ridefinder/images/mm_20_blue.png';
            //iconBlue.shadow = 'http://labs.google.com/ridefinder/images/mm_20_shadow.png';
            iconBlue.size = new google.maps.Size(12, 20);
            iconBlue.anchor = new google.maps.Point(6, 20);
            iconBlue.origin = new google.maps.Point(0, 0);
	    
	        var latlng = new google.maps.LatLng(37.77493, -122.41942);
            var myOptions = {
                zoom: 13,
                center: latlng,
                mapTypeId: google.maps.MapTypeId.ROADMAP
                
            };
            
            map = new google.maps.Map(document.getElementById("muralmap"), myOptions);
	        updateMarkers();
	        
	        function updateMarkers() {
	            $.getJSON('_list/geojson/locations', function(data) {
                    var items = [];
                    //console.log(data);

                    $.each(data.features, function(key, val) {
                        if(allMarkers.indexOf(val.properties.id) == -1) {
                            var name = val.properties.name;
                            var text = val.properties.text;
                            var imagepath = val.properties.tweet_image;
                            var thumbnail = val.properties.thumbnail;
                            var point = new google.maps.LatLng(parseFloat(val.geometry.coordinates[1]), parseFloat(val.geometry.coordinates[0]));
                            //var marker = createMarker(point, name, imagepath, text, thumbnail);
                            allMarkers.push(val.properties.id);
                            markers.push(new google.maps.Marker({
                                position: point,
                                map: map,
                                draggable: false,
                                icon: iconBlue,
                                animation: google.maps.Animation.DROP
                            }));
                        }
                    });
                    /*
                    setInterval((function (){
                        var cur_marker = items.pop();
                        console.log(cur_marker);
                        //cur_marker.setMap(map);
                        console.log(cur_marker);
                        //map.panTo(cur_marker.getPosition());
                        
                    }), 2000);
                    */
                });
	        }

            function createMarker(point, name, image, text, thumbnail) {


                var html = "<div class=\"bubble_details\">"+
                            "<div class=\"bubble_img_container\" >"+
                              "<img class=\"bubble_img\" src=\""+image+ "\"/>"+
                            "</div>"+
                            "<div class=\"bubble_profile\">"+
                              "<a href=http://twitter.com/"+ name + " target=\"_blank\"><img id=\"thumb\" src=\"" + thumbnail + "\"/></a>"+
                              "<span>@" + name + "</span>"+
                            "</div>";
                html += "<div class=\"bubble_text\">"+text.parseURL().parseUsername().parseHashtag()+"</div></div>";
                
                var markerOptions = {
                    position: point,
                    icon: iconBlue
                }
                var infowindow = new google.maps.InfoWindow({
                    content: html
                });
                var marker = new google.maps.Marker(markerOptions);
                
                google.maps.event.addListener(marker, 'click', function() {
                  infowindow.open(map,marker);
                });
                
                return marker;
            }
	      
          
            String.prototype.parseURL = function() {
            	return this.replace(/[A-Za-z]+:\/\/[A-Za-z0-9-_]+\.[A-Za-z0-9-_:%&~\?\/.=]+/g, function(url) {
            		return url.link(url);
            	});
            };
          
            String.prototype.parseUsername = function() {
            	return this.replace(/[@]+[A-Za-z0-9-_]+/g, function(u) {
            		var username = u.replace("@","")
            		return u.link("http://twitter.com/"+username);
            	});
            };

            String.prototype.parseHashtag = function() {
            	return this.replace(/[#]+[A-Za-z0-9-_]+/g, function(t) {
            		var tag = t.replace("#","%23")
            		return t.link("http://search.twitter.com/search?q="+tag);
            	});
            };

	    });
    </script>
    <script src="/_utils/script/json2.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
    
    <script src="/_utils/script/jquery.couch.js"></script>
</html>
